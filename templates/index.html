<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¿ ä¸­è‰è¯è¯†åˆ«ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* è½»å¾®æ¸å˜èƒŒæ™¯ */
    body{
      background:linear-gradient(135deg,#eef7f2 0%,#f8fbf9 100%);
      min-height:100vh;
    }
    /* é¢„è§ˆå›¾æ ·å¼ */
    #preview{
      width:224px;height:224px;
      object-fit:cover;
      border-radius:1rem;
      box-shadow:0 6px 18px rgba(0,0,0,.1);
    }
    /* å¡ç‰‡å…¬å…±é˜´å½± */
    .soft-card{
      border:none;
      border-radius:1.25rem;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
    }
    /* é¡¶éƒ¨æ ‡é¢˜æ¸å˜å­— */
    .brand-text{
      background:linear-gradient(90deg,#1faa59,#4cd964);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-weight:700;
    }
  </style>
</head>
<body class="d-flex justify-content-center align-items-start pt-5" style="gap:48px;">

  <!-- å·¦ä¾§æ“ä½œåŒº -->
  <div class="card soft-card p-4 d-flex flex-column align-items-center" style="width: 340px;">
    <h2 class="brand-text mb-3">ğŸŒ¿ ä¸­è‰è¯è¯†åˆ«</h2>

    <img id="preview" src="" alt="é¢„è§ˆ" class="mb-3">

    <h5 id="result" class="mb-4 text-primary">è¯·ä¸Šä¼ å›¾ç‰‡æˆ–æ‰“å¼€æ‘„åƒå¤´</h5>

    <!-- ä¸Šä¼  -->
    <label class="w-100 mb-3">
      <input type="file" id="imgInput" accept="image/*" class="form-control rounded-pill">
    </label>

    <!-- æ‘„åƒå¤´ç”»é¢ -->
    <video id="video" width="224" height="224" autoplay class="d-none mb-3 rounded-3 shadow"></video>

    <!-- æŒ‰é’®ç»„ -->
    <div class="d-flex flex-wrap justify-content-center" style="gap:12px">
      <button id="camBtn"  class="btn btn-warning rounded-pill px-4">ğŸ“· æ‰“å¼€/å…³é—­æ‘„åƒå¤´</button>
      <button id="snapBtn" class="btn btn-success rounded-pill px-4 d-none">ğŸ¯ æ‹ç…§è¯†åˆ«</button>
    </div>
  </div>

  <!-- å³ä¾§ Top-5 ç»“æœåŒº -->
  <div id="top5" class="card soft-card p-4" style="width: 340px; min-height: 160px;">
    <h6 class="text-secondary">Top-5 é¢„æµ‹ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</h6>
  </div>

  <script>
    const imgInput = document.getElementById("imgInput");
    const preview  = document.getElementById("preview");
    const result   = document.getElementById("result");
    const video    = document.getElementById("video");
    const camBtn   = document.getElementById("camBtn");
    const snapBtn  = document.getElementById("snapBtn");
    let stream = null;

    // ä¸Šä¼ å›¾ç‰‡
    imgInput.addEventListener("change", () => {
      const file = imgInput.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      setLoading();
      sendImage(file);
    });

    // æ‘„åƒå¤´æ§åˆ¶
    camBtn.onclick = async () => {
      if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width:224, height:224 }});
        video.srcObject = stream;
        video.classList.remove("d-none");
        snapBtn.classList.remove("d-none");
        camBtn.textContent = "âŒ å…³é—­æ‘„åƒå¤´";
      } else {
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
        video.classList.add("d-none");
        snapBtn.classList.add("d-none");
        camBtn.textContent = "ğŸ“· æ‰“å¼€æ‘„åƒå¤´";
      }
    };

    // æ‹ç…§è¯†åˆ«
    snapBtn.onclick = () => {
      const canvas = document.createElement("canvas");
      canvas.width=224;canvas.height=224;
      canvas.getContext("2d").drawImage(video,0,0,224,224);
      canvas.toBlob(blob=>{
        preview.src = canvas.toDataURL();
        setLoading();
        sendImage(blob,"snapshot.jpg");
      },"image/jpeg");
    };

    // å‘é€å›¾ç‰‡
    function sendImage(file, filename="upload.jpg"){
      const fd = new FormData(); fd.append("image",file,filename);
      fetch("/api/predict",{method:"POST",body:fd})
      .then(r=>r.json())
      .then(d=>renderResult(d))
      .catch(()=>showError("è¯†åˆ«å¤±è´¥ï¼"));
    }

    // æ¸²æŸ“ç»“æœ
    function renderResult(d){
      result.textContent = "è¯†åˆ«ç»“æœï¼š" + d.prediction;
      result.className = "mb-4 fw-semibold " + (d.prediction==="æ— æ³•è¯†åˆ«"?"text-danger":"text-primary");
      const top5Div = document.getElementById("top5");
      if(!d.top5){ top5Div.innerHTML = "<p class='text-muted'>æœªè¿”å› Top-5 æ•°æ®</p>";return;}

      let html = "<h6 class='mb-3 text-secondary'>Top-5 é¢„æµ‹ï¼š</h6><ul class='list-group'>";
      d.top5.forEach(item=>{
        const percent = (item.probability*100).toFixed(2);
        const isTop1 = item.class===d.prediction && d.prediction!=="æ— æ³•è¯†åˆ«";
        html += `
          <li class='list-group-item d-flex justify-content-between align-items-center border-0'>
            <span class='${isTop1?"fw-bold":""}'>${item.class}</span>
            <span class='badge ${isTop1?"bg-success":"bg-primary"} rounded-pill'>${percent}%</span>
          </li>`;
      });
      html += "</ul>";
      top5Div.innerHTML = html;
    }

    // çŠ¶æ€è¾…åŠ©
    function setLoading(){ showInfo("è¯†åˆ«ä¸­...", "text-secondary"); }
    function showError(msg){ showInfo(msg, "text-danger"); }
    function showInfo(msg, cls){
      result.textContent = msg;
      result.className = "mb-4 "+cls;
    }
  </script>
</body>
</html>
